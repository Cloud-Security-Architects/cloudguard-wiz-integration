# Automated Export of Access & NAT Policies to JSON for Wiz

This guide provides step-by-step instructions for enabling local logging of policies on Check Point Security Gateways. Please review Check Point documentation SK for general information: [sk183560 - Exporting Security Policy on a Security Gateway](https://support.checkpoint.com/results/sk/sk183560)
> **ℹ️ Note:**  This document was prepared with Wiz in mind; but it should work with other 3rd party  that require access to NAT and Access Rules.

## Overview

This installation deploys a small exporter on each gateway that periodically writes the Access Control and NAT rulebases to JSON files under `/var/log/rulebase_dump/`, ready for ingestion by Wiz and other external tools.

## Installation

### The Installer Command
Paste the following command as-is to fetch the current package from the gateway's `$CPDIR/ONLINE_SERVICES` cache, make the exporter script executable, and run its install action (which also schedules periodic exports):

```bash
UO_REVISION=$(grep -oP '(?<=<Last_Revision>)[0-9]+' "$CPDIR/database/downloads/ONLINE_SERVICES/1.0/last_revision.xml") ; chmod +x $CPDIR/database/downloads/ONLINE_SERVICES/1.0/$UO_REVISION/static_files/rulebase_dump/rulebase_dump.sh ; $CPDIR/database/downloads/ONLINE_SERVICES/1.0/$UO_REVISION/static_files/rulebase_dump/rulebase_dump.sh install
```

### Network Prerequisites
The installer reads the current package from `$CPDIR/.../ONLINE_SERVICES`. Make sure gateways have outbound connectivity (or a proxy) to fetch this content.
If the wrapper logs `Cannot find last_revision.xml`, fix connectivity and re-apply via the CME template (bump generation) or run the installer command again.
> **ℹ️ Note:** If you're using the wrapper, you can re-run it with `FORCE=1`.

## Expected Results
After installation, JSON files will be generated under `/var/log/rulebase_dump/`:
- `AccessRB_0.json` (or `AccessRB_<VSID>.json` on VSX)
- `NatRB_0.json` (or `NatRB_<VSID>.json` on VSX)

> **ℹ️ Note:** The first JSON may not appear immediately; it is generated by the exporter's scheduled run. Exports typically run twice daily (about every 12 hours).


## For Autoscaled Instances
### Via CME Gateway Template

The following steps ensure that every autoscaled instance (AWS ASG, Azure VMSS, OCI IG, etc.) runs the installer after policy installation, eliminating the need for manual steps.

### Create A Wrapper Script

#### Why a wrapper

The wrapper provides clear logging at `/var/log/rulebase_dump/setup.log`, idempotence via a stamp file, and keeps the one-liner intact for auditing.

#### Wrapper Script Details

> **⚠️ Important:** The following 'Wrapper Script' should be saved as `install_rulebase_dump.sh`

#### Where to save the Wrapper Script

Save the wrapper anywhere on your admin workstation. For instance: `~/cme-scripts/install_rulebase_dump.sh`.
You can [copy the script here](https://github.com/Cloud-Security-Architects/cloudguard-wiz-integration/blob/main/install_rulebase_dump.sh).

- **If you use the API:** upload it as Base64 into the Management Scripts Repository.
- **If you use the UI:** open Scripts Repository in SmartConsole and paste the script in cleartext (no Base64 needed).

> **ℹ️ Notes:**
> 1. The script does not need to live on gateways; CME delivers it when the template runs after policy install.
> 2. The script is stored in the Management Scripts Repository (UI = cleartext, API = Base64). It does not persist on gateways; CME transmits it to be run after policy install.
